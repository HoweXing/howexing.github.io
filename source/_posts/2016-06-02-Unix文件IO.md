---
title: Unix文件IO
date: 2016-06-02 22:53:48
tags: 
  - unix
  - c
---
Unix系统的文件IO及函数调用。

## 文件描述符

文件描述符是一个非负整数，又内核分配，函数open和creat返回文件描述符，函数read和write需要文件描述符作为参数。

在Unix系统中，文件描述符0，1，2有代表特殊的IO：

* 0 \- 标准输入（stdin）
* 1 \- 标准输出（stdout）
* 2 \- 标准错误（stderr）
<!--more-->
文件描述符的上限又操作系统的OPEN\_MAX标识，表示一个进程最多能打开的文件个数，相应的文件描述符范围为 0\-OPEN\_MAX-1。

## 函数open和openat

```cpp
#include <fcntl.h>
int open(const char *path, int oflag, ... /* mode_t mode */);
int openat(int fd, const char *path, int oflag, ... /* mode_t mode */);
```

打开文件，并以当前最小可用文件描述符返回。

带有at的函数一般是对应不带at的函数的相对路径版本，作为参照物的就是带有at函数的第一个参数（文件描述符），在文件IO的函数集中有很多这样的函数对。

对于带有at的函数，有三种可能性：

* path是绝对路径，fd被忽略，和不带at的函数效果相同
* path是相对路径，则相对于fd所指示的目录，如果fd是AT_FDCWD，则相对于当前工作目录

添加带有at的文件IO函数，有两个目的：

1. 让进程内部线程可以使用相对路径打开目录中的文件，而不再只能打开当前工作目录
2. 避免time\-of\-check\-to\-time错误，这是一种漏洞，比如在检查文件和使用文件的非原子操作之间替换掉原始文件

若\_POSIX\_NO\_TRUNC有效，则当路径名长度超过PATH\_MAX或路径中任意文件名长度超过NAME\_MAX时，出错返回，并设errno为ENAMETOOLONG，可以使用fpathconf或pathconf来查看\_POSIX\_NO\_TRUNC状态。

## 函数creat

```cpp
#include <fcntl.h>
int creat(const char *path, mode_t mode);
```

该函数相当于设置了对应oflag参数的open函数

```cpp
open(path, O_WRONLY | O_CREAT | O_TRUNC, mode);
```

对于creat函数，不足之处是WRONLY，如果要既写又读文件，则需要先close再次open，其实这种需求可以用open函数设置合适oflag参数达成

```cpp
open(path, O_RDWR | O_CREAT | O_TRUNC, mode);
```
